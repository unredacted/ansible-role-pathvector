#!/bin/bash
# UniFi on-boot script to install Bird (bird2/bird3) and pathvector
# Auto-deployed by Ansible
# Place this file in /data/on_boot.d/ (UniFi OS) or /config/scripts/post-config.d/ (EdgeOS)
# Make it executable: chmod +x /data/on_boot.d/1-unifi-pathvector-setup.sh

# Bird Configuration Variables (templated by Ansible)
BIRD_VERSION="{{ bird_version | default('bird2') }}"
BIRD_INSTALL_FROM_OFFICIAL="{{ bird_install_from_official | default(true) | lower }}"
BIRD_GPG_KEY_URL="{{ bird_gpg_key_url | default('https://pkg.labs.nic.cz/gpg') }}"

# Pathvector Configuration Variables (templated by Ansible)
PGP_KEY_URL="{{ pathvector_pgp_key_url | default('https://repo.pathvector.io/pgp.asc') }}"
REPO_URL="{{ pathvector_repo_url | default('https://repo.pathvector.io/apt/') }}"
REPO_DIST="{{ pathvector_repo_dist | default('stable') }}"
REPO_COMPONENT="{{ pathvector_repo_component | default('main') }}"

# Script Configuration
SCRIPT_NAME="unifi-pathvector-setup"
LOG_FILE="/var/log/${SCRIPT_NAME}.log"
CONFIG_SOURCE="/data/on_boot.d/pathvector.yml"
CONFIG_DEST="{{ pathvector_config_path | default('/etc/pathvector.yml') }}"
UNIFI_ON_BOOT_VERSION="{{ unifi_on_boot_version | default('1.0.0') }}"
UNIFI_ON_BOOT_URL="https://github.com/{{ unifi_on_boot_github_repo | default('unredacted/unifi-on-boot') }}/releases/download/v${UNIFI_ON_BOOT_VERSION}/unifi-on-boot_${UNIFI_ON_BOOT_VERSION}_all.deb"
MODE="install"
FORCE_MODE=false
SKIP_SHADOW=false
PRIMARY_STATUS="UNKNOWN"
SHADOW_STATUS="NOT DETECTED"
SHADOW_IP="169.254.254.3"

# Parse command line arguments
# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --install)
            MODE="install"
            shift
            ;;
        --check)
            MODE="check"
            shift
            ;;
        --cron)
            MODE="cron"
            shift
            ;;
        --skip-shadow)
            SKIP_SHADOW=true
            shift
            ;;
        --force)
            FORCE_MODE=true
            shift
            ;;
        --help)
            echo "Usage: $0 [--install|--check|--cron] [--force]"
            echo "  --install  Install/Update packages and config (default)"
            echo "  --check    Check status of services"
            echo "  --cron     Run in cron mode (ensure services running, auto-start)"
            echo "  --force    Force update/re-install"
            echo "  --skip-shadow Skip shadow gateway checks (internal use)"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Function to print summary
print_summary() {
    echo ""
    echo "=================================================="
    echo "              EXECUTION SUMMARY                   "
    echo "=================================================="
    echo "Mode: $MODE"
    echo "Primary Gateway: $PRIMARY_STATUS"
    if [ "$SKIP_SHADOW" != "true" ]; then
        echo "Shadow Gateway:  $SHADOW_STATUS"
    fi
    echo "=================================================="
    echo ""
}

# Determine the correct bird service unit name
detect_bird_unit() {
    # Try common unit names in order
    for unit in bird.service bird2.service bird3.service; do
        if systemctl list-unit-files --type=service 2>/dev/null | awk '{print $1}' | grep -qx "$unit"; then
            echo "$unit"
            return 0
        fi
    done
    # Fallback: if bird is installed but unit scan failed, try 'bird.service'
    echo "bird.service"
}

# Ensure a service is enabled and started (with a network-online dependency for Bird)
ensure_enabled_and_started() {
    local svc="$1"

    # Add a drop-in so the service waits for the network to be online (useful for routing daemons)
    local dropin_dir="/etc/systemd/system/${svc}.d"
    mkdir -p "$dropin_dir"
    cat > "${dropin_dir}/override.conf" <<'EOF'
[Unit]
Wants=network-online.target
After=network-online.target
EOF

    # Reload, enable on boot, and start (or restart if already running)
    systemctl daemon-reload
    systemctl enable --now "$svc" 2>/dev/null || systemctl enable "$svc" 2>/dev/null
    if systemctl is-active --quiet "$svc"; then
        systemctl restart "$svc"
    else
        systemctl start "$svc" || true
    fi
}

# Function to setup pathvector configuration
setup_pathvector_config() {
    log_message "Setting up pathvector configuration..."

    # Check if source config exists
    if [ ! -f "$CONFIG_SOURCE" ]; then
        log_message "WARNING: Source configuration file $CONFIG_SOURCE not found, skipping config setup"
        return 1
    fi

    # Copy configuration file
    log_message "Copying pathvector configuration from $CONFIG_SOURCE to $CONFIG_DEST"
    if cp "$CONFIG_SOURCE" "$CONFIG_DEST"; then
        log_message "Configuration copied successfully"

        # Generate pathvector configuration
        log_message "Running pathvector generate..."
        if pathvector generate 2>&1 | tee -a "$LOG_FILE"; then
            log_message "pathvector generate completed successfully"
            return 0
        else
            log_message "ERROR: pathvector generate failed"
            return 1
        fi
    else
        log_message "ERROR: Failed to copy configuration file"
        return 1
    fi
}

# Function to handle shadow gateway
handle_shadow_gateway() {
    local shadow_ip="169.254.254.3"
    local shadow_user="root" # Assuming root access is available/keyed

    if [ "$SKIP_SHADOW" = "true" ]; then
        return 0
    fi

    if ping -c 1 -W 1 "$SHADOW_IP" >/dev/null 2>&1; then
        log_message "Shadow gateway detected at $SHADOW_IP"
        
        # Copy script and config to shadow
        log_message "Copying script and config to shadow gateway..."
        if scp "$0" "${shadow_user}@${SHADOW_IP}:${0}" && \
           scp "$CONFIG_SOURCE" "${shadow_user}@${SHADOW_IP}:${CONFIG_SOURCE}"; then
            
            # Run setup on shadow
            log_message "Running setup on shadow gateway..."
            if ssh "${shadow_user}@${SHADOW_IP}" "bash -s" <<EOF
                # Install unifi-on-boot if not present
                if ! dpkg -l unifi-on-boot >/dev/null 2>&1; then
                    echo "Installing unifi-on-boot on shadow gateway..."
                    curl -fsSL "${UNIFI_ON_BOOT_URL}" -o "unifi-on-boot_${UNIFI_ON_BOOT_VERSION}_all.deb"
                    dpkg -i "unifi-on-boot_${UNIFI_ON_BOOT_VERSION}_all.deb"
                    rm "unifi-on-boot_${UNIFI_ON_BOOT_VERSION}_all.deb"
                fi
                
                # Run the script
                chmod +x "$0"
                "$0" --${MODE} --skip-shadow $( [ "$FORCE_MODE" = "true" ] && echo "--force" )
EOF
            then
                SHADOW_STATUS="SUCCESS"
                log_message "Shadow gateway setup completed successfully"
            else
                SHADOW_STATUS="FAILURE"
                log_message "ERROR: Shadow gateway setup failed"
            fi
        else
            SHADOW_STATUS="COPY_FAILED"
            log_message "ERROR: Failed to copy files to shadow gateway"
        fi
    else
        SHADOW_STATUS="NOT DETECTED"
    fi
}

# Function to run cron checks
run_cron_checks() {
    log_message "Running cron checks..."
    
    # Check if services are running
    local bird_unit
    bird_unit="$(detect_bird_unit)"
    
    if ! systemctl is-active --quiet "$bird_unit"; then
        log_message "Bird service ($bird_unit) is not running. Restarting..."
        systemctl restart "$bird_unit"
    fi
    
    if ! systemctl is-enabled --quiet "$bird_unit"; then
        log_message "Bird service ($bird_unit) is not enabled. Enabling..."
        systemctl enable "$bird_unit"
    fi
}

# Main Script Start
log_message "Starting $SCRIPT_NAME in $MODE mode"

# Handle Shadow Gateway first
handle_shadow_gateway

case $MODE in
    cron)
        run_cron_checks
        PRIMARY_STATUS="SUCCESS" # Cron checks are usually silent/safe
        ;;
        
    check)
        BIRD_UNIT="$(detect_bird_unit)"
        PRIMARY_STATUS="SUCCESS"

        # Check Bird Service
        if systemctl list-unit-files --type=service 2>/dev/null | grep -q "$BIRD_UNIT"; then
             if systemctl is-active --quiet "$BIRD_UNIT"; then
                 log_message "Service $BIRD_UNIT is running"
                 systemctl status "$BIRD_UNIT" --no-pager
             else
                 log_message "WARNING: Service $BIRD_UNIT is not running"
                 systemctl status "$BIRD_UNIT" --no-pager
                 PRIMARY_STATUS="FAILURE"
             fi
        else
             log_message "ERROR: Service $BIRD_UNIT not found"
             PRIMARY_STATUS="FAILURE"
        fi

        # Check Pathvector
        if command -v pathvector >/dev/null 2>&1; then
            pathvector version
            log_message "Running pathvector generate..."
            if ! pathvector generate; then
                log_message "ERROR: pathvector generate failed"
                PRIMARY_STATUS="FAILURE"
            fi
        else
            log_message "ERROR: pathvector command not found"
            PRIMARY_STATUS="FAILURE"
        fi

        # Check Bird Binary
        if command -v bird >/dev/null 2>&1; then
            bird --version
        else
            log_message "ERROR: bird command not found"
            PRIMARY_STATUS="FAILURE"
        fi
        ;;
        
    install)
        log_message "Bird version: $BIRD_VERSION, Install from official: $BIRD_INSTALL_FROM_OFFICIAL"
        if [ "$FORCE_MODE" = "true" ]; then
            log_message "Running in FORCE mode - will update packages and re-add repositories"
        fi

        # If already installed (and not forcing), still ensure services are enabled/started and config is applied
        if [ "$FORCE_MODE" != "true" ] && command -v pathvector >/dev/null 2>&1 && command -v bird >/dev/null 2>&1; then
            log_message "$BIRD_VERSION and pathvector are already installed"

            # Apply config if present
            setup_pathvector_config

            # Ensure services are enabled and started now and on future boots
            BIRD_UNIT="$(detect_bird_unit)"
            log_message "Ensuring Bird service is enabled and started (unit: $BIRD_UNIT)..."
            ensure_enabled_and_started "$BIRD_UNIT"

            log_message "$SCRIPT_NAME completed (packages already installed)"
            PRIMARY_STATUS="SUCCESS"
            print_summary
            exit 0
        fi

        # Force mode or not installed: proceed with installation
        if [ "$FORCE_MODE" = "true" ]; then
             log_message "Force mode enabled - proceeding with repository and package updates"
        fi
        
        log_message "Installing $BIRD_VERSION and pathvector..."

        # Install prerequisite packages
        log_message "Installing prerequisite packages..."
        DEBIAN_FRONTEND=noninteractive apt update >/dev/null 2>&1
        DEBIAN_FRONTEND=noninteractive apt install -y apt-transport-https ca-certificates wget lsb-release curl >/dev/null 2>&1

        # Get distribution codename
        DISTRO_CODENAME=$(lsb_release -cs 2>/dev/null || echo "bullseye")
        log_message "Detected distribution codename: $DISTRO_CODENAME"

        # Setup Bird repository if using official repos
        if [ "$BIRD_INSTALL_FROM_OFFICIAL" = "true" ]; then
            # Add CZ.NIC Bird repository key (force re-add in force mode)
            if [ "$FORCE_MODE" = "true" ] || ! [ -f /usr/share/keyrings/cznic-labs-pkg.gpg ]; then
                log_message "Adding CZ.NIC Bird repository key from $BIRD_GPG_KEY_URL..."
                if wget -q -O /usr/share/keyrings/cznic-labs-pkg.gpg "$BIRD_GPG_KEY_URL"; then
                    log_message "CZ.NIC repository key added successfully"
                else
                    log_message "ERROR: Failed to download CZ.NIC repository key from $BIRD_GPG_KEY_URL"
                    exit 1
                fi
            else
                log_message "CZ.NIC repository key already exists"
            fi

            # Add Bird repository (force re-add in force mode)
            BIRD_REPO_FILE="/etc/apt/sources.list.d/cznic-labs-${BIRD_VERSION}.list"
            if [ "$FORCE_MODE" = "true" ] || ! [ -f "$BIRD_REPO_FILE" ]; then
                log_message "Adding $BIRD_VERSION repository..."
                echo "deb [signed-by=/usr/share/keyrings/cznic-labs-pkg.gpg] https://pkg.labs.nic.cz/${BIRD_VERSION} ${DISTRO_CODENAME} main" > "$BIRD_REPO_FILE"
                log_message "Bird repository added: https://pkg.labs.nic.cz/${BIRD_VERSION} ${DISTRO_CODENAME} main"
            else
                log_message "Bird repository already configured"
            fi
        fi

        # Add pathvector repository key (force re-add in force mode)
        if [ "$FORCE_MODE" = "true" ] || ! [ -f /usr/share/keyrings/pathvector.asc ]; then
            log_message "Adding pathvector repository key from $PGP_KEY_URL..."
            if curl -fsSL "$PGP_KEY_URL" > /usr/share/keyrings/pathvector.asc; then
                log_message "Repository key added successfully"
            else
                log_message "ERROR: Failed to download repository key from $PGP_KEY_URL"
                exit 1
            fi
        else
            log_message "Repository key already exists"
        fi

        # Add pathvector repository (force re-add in force mode)
        if [ "$FORCE_MODE" = "true" ] || ! [ -f /etc/apt/sources.list.d/pathvector.list ]; then
            log_message "Adding pathvector repository..."
            echo "deb [signed-by=/usr/share/keyrings/pathvector.asc] $REPO_URL $REPO_DIST $REPO_COMPONENT" > /etc/apt/sources.list.d/pathvector.list
            log_message "Repository added: $REPO_URL $REPO_DIST $REPO_COMPONENT"
        else
            log_message "Repository already configured"
        fi

        # Update package list
        log_message "Updating package list..."
        if apt update >/dev/null 2>&1; then
            log_message "Package list updated successfully"
        else
            log_message "WARNING: Failed to update package list completely"
        fi

        # Install or update packages
        if [ "$FORCE_MODE" = "true" ]; then
            log_message "Force updating pathvector and $BIRD_VERSION to latest versions..."
            if DEBIAN_FRONTEND=noninteractive apt install --only-upgrade -y pathvector $BIRD_VERSION >/dev/null 2>&1; then
                log_message "Packages updated successfully"
            else
                log_message "No updates available or packages not installed yet, performing fresh install..."
                if DEBIAN_FRONTEND=noninteractive apt install -y pathvector $BIRD_VERSION >/dev/null 2>&1; then
                    log_message "Installation completed successfully"
                else
                    log_message "ERROR: Failed to install/update packages"
                    exit 1
                fi
            fi
        else
            log_message "Installing pathvector and $BIRD_VERSION..."
            if DEBIAN_FRONTEND=noninteractive apt install -y pathvector $BIRD_VERSION >/dev/null 2>&1; then
                log_message "Installation completed successfully"
            else
                log_message "ERROR: Failed to install packages"
                exit 1
            fi
        fi

        # Verify installation
        if command -v pathvector >/dev/null 2>&1; then
            PATHVECTOR_VERSION=$(pathvector version 2>/dev/null || echo "unknown")
            log_message "pathvector installed: version $PATHVECTOR_VERSION"
        else
            log_message "WARNING: pathvector command not found after installation"
        fi

        if command -v bird >/dev/null 2>&1; then
            BIRD_VERSION_INFO=$(bird --version 2>&1 | head -n1 || echo "unknown")
            log_message "$BIRD_VERSION installed: $BIRD_VERSION_INFO"
        else
            log_message "WARNING: bird command not found after installation"
        fi

        # Setup pathvector configuration after successful installation
        setup_pathvector_config

        # Enable + (re)start services so they come up now and on future boots
        BIRD_UNIT="$(detect_bird_unit)"
        log_message "Enabling and starting Bird service (unit: $BIRD_UNIT)..."
        ensure_enabled_and_started "$BIRD_UNIT"
        ;;
esac

log_message "$SCRIPT_NAME completed"

if [ "$PRIMARY_STATUS" = "UNKNOWN" ]; then
    PRIMARY_STATUS="SUCCESS"
fi

print_summary

if [ "$PRIMARY_STATUS" = "FAILURE" ] || [ "$SHADOW_STATUS" = "FAILURE" ] || [ "$SHADOW_STATUS" = "COPY_FAILED" ]; then
    exit 1
else
    exit 0
fi
